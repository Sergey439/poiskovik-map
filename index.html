<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Карта Поисковика</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 300px;
    }
    #controls input, #controls textarea, #controls select, #controls button {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <select id="filterCategory">
      <option value="">Все категории</option>
      <option value="История">История</option>
      <option value="Укрепление">Укрепление</option>
    </select>
    <input type="text" id="searchInput" placeholder="Поиск по названию" />
    <hr>
    <input type="text" id="name" placeholder="Название объекта" />
    <textarea id="desc" placeholder="Описание объекта"></textarea>
    <input type="text" id="coords" placeholder="Координаты (lat,lng)" />
    <select id="category">
      <option value="История">История</option>
      <option value="Укрепление">Укрепление</option>
    </select>
    <button onclick="addObject()">Добавить объект</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbw_MBtaH4cnULuZeF8dIOwSKB3qvXwVGFYX1td4gq-sqow1IKJ6Vub5HXk2Je_vPLP4bw/exec";

    const map = L.map('map').setView([49.803, 73.109], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
    }).addTo(map);

    let markers = [];

    async function loadObjects() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      displayObjects(data);
    }

    function displayObjects(objects) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      const filter = document.getElementById("filterCategory").value.toLowerCase();
      const search = document.getElementById("searchInput").value.toLowerCase();

      objects.forEach(obj => {
        if (
          (filter === '' || obj.category.toLowerCase() === filter) &&
          (search === '' || obj.name.toLowerCase().includes(search))
        ) {
          const [lat, lng] = obj.coords.split(',').map(Number);
          const marker = L.marker([lat, lng])
            .addTo(map)
            .bindPopup(`<b>${obj.name}</b><br>${obj.desc}<br><i>${obj.category}</i>`);
          markers.push(marker);
        }
      });
    }

    async function addObject() {
      const name = document.getElementById("name").value.trim();
      const desc = document.getElementById("desc").value.trim();
      const coords = document.getElementById("coords").value.trim();
      const category = document.getElementById("category").value.trim();

      if (!name || !coords) {
        alert("Введите как минимум название и координаты");
        return;
      }

      const res = await fetch(apiUrl, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, desc, coords, category })
      });

      if (res.ok) {
        alert("Объект добавлен!");
        loadObjects();
      } else {
        alert("Ошибка при добавлении");
      }
    }

    document.getElementById("filterCategory").addEventListener("change", loadObjects);
    document.getElementById("searchInput").addEventListener("input", loadObjects);

    loadObjects();
  </script>
</body>
</html>


     
