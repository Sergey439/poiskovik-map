<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Карта Поисковика</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; }
    .form-box {
      position: absolute; top: 10px; left: 10px; background: white; padding: 10px;
      z-index: 1000; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 300px;
    }
    input, select, textarea, button {
      width: 100%; margin-top: 5px; margin-bottom: 10px; padding: 8px;
    }
  </style>
</head>
<body>
  <div class="form-box">
    <select id="filter-category">
      <option value="">Все категории</option>
      <option value="История">История</option>
      <option value="Укрепление">Укрепление</option>
      <option value="Поселение">Поселение</option>
    </select>
    <input type="text" id="search" placeholder="Название объекта">
    <textarea id="description" placeholder="Описание объекта"></textarea>
    <input type="text" id="coords" placeholder="Координаты (lat,lng)">
    <select id="add-category">
      <option value="История">История</option>
      <option value="Укрепление">Укрепление</option>
      <option value="Поселение">Поселение</option>
    </select>
    <button onclick="addObject()">Добавить объект</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const sheetUrl = 'https://script.google.com/macros/s/AKfycbw_MBtaH4cnULuZeF8dIOwSKB3qvXwVGFYX1td4gq-sqow1IKJ6Vub5HXk2Je_vPLP4bw/exec';

    const map = L.map('map').setView([49.8, 73.1], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = [];

    function loadData() {
      fetch(sheetUrl)
        .then(res => res.json())
        .then(data => {
          clearMarkers();

          const search = document.getElementById('search').value.toLowerCase();
          const category = document.getElementById('filter-category').value;

          data.forEach(obj => {
            const matchCategory = !category || obj.category === category;
            const matchSearch = !search || obj.name.toLowerCase().includes(search);

            if (matchCategory && matchSearch) {
              const [lat, lng] = obj.coords.split(',').map(Number);
              const marker = L.marker([lat, lng])
                .bindPopup(`<b>${obj.name}</b><br>${obj.description}`)
                .addTo(map);
              markers.push(marker);
            }
          });
        });
    }

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function addObject() {
      const name = document.getElementById('search').value;
      const description = document.getElementById('description').value;
      const coords = document.getElementById('coords').value;
      const category = document.getElementById('add-category').value;

      if (!name || !coords) {
        alert("Название и координаты обязательны.");
        return;
      }

      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      formData.append('coords', coords);
      formData.append('category', category);

      fetch(sheetUrl, {
        method: 'POST',
        body: formData
      }).then(() => {
        alert("Объект добавлен!");
        loadData();
      });
    }

    document.getElementById('search').addEventListener('input', loadData);
    document.getElementById('filter-category').addEventListener('change', loadData);

    loadData();
  </script>
</body>
</html>
